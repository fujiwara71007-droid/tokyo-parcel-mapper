<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Tokyo Parcel Mapper - MVP</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    #ui{position:fixed;top:.5rem;left:.5rem;right:.5rem;background:#fff;padding:.5rem;border-radius:.6rem;
        box-shadow:0 4px 16px rgba(0,0,0,.08);font-family:system-ui;z-index:10}
    #ui .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.25rem 0}
    .pill{padding:.4rem .6rem;border:1px solid #ddd;border-radius:.6rem}
    .btn{padding:.5rem .8rem;border:1px solid #111;background:#111;color:#fff;border-radius:.6rem}
    #toast{position:fixed;bottom:.8rem;left:50%;transform:translateX(-50%);background:#111;color:#fff;
           padding:.4rem .6rem;border-radius:.6rem;display:none;z-index:20}
    #busy{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:15}
    #busy .box{background:#fff;padding:1rem 1.2rem;border-radius:.8rem;box-shadow:0 8px 24px rgba(0,0,0,.2);font-weight:600}
  </style>
</head>
<body>
<div id="map"></div>

<div id="ui">
  <div class="row"><b>Tokyo Parcel Mapper – MVP</b></div>
  <div class="row">
    <label class="pill"><input id="follow" type="checkbox" checked> 現在地に追従</label>
    <button id="goto" class="btn">現在地へ</button>
  </div>
  <div class="row">
    <select id="category" class="pill">
      <option>駐車場</option><option>古屋</option><option>空き家</option>
      <option>更地</option><option>古アパート</option><option>その他</option>
    </select>
    <input id="memo" class="pill" placeholder="メモ（任意）" />
    <input id="photo" class="pill" type="file" accept="image/*" capture="environment" />
    <button id="send" class="btn" disabled>この地点を送信</button>
  </div>
  <div class="row" style="font-size:.9rem;color:#666">
    地図をタップ → 点を作成 → 送信でシートに保存（住所は 丁目＋番地 まで）
  </div>
</div>

<div id="busy"><div class="box">送信中…</div></div>
<div id="toast"></div>

<script>
  /* ←必要ならあなたの /exec に変更 */
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw4wmqV__4kQO77AJmSLpyuLQH9tSblJJfxCWhIqHdpeEbX23ZZzEj2RV0OpwyK3sv5/exec';
  const GSI = "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png";

  /* UIユーティリティ */
  const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m;
    t.style.display='block'; clearTimeout(window._to); window._to=setTimeout(()=>t.style.display='none',2200); };
  const showBusy = (on)=>{ document.getElementById('busy').style.display = on ? 'flex' : 'none'; };

  /* 画像処理 */
  const toDataURL = (f)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
  function dataUrlBytes(u){ const b64=(u.split(',')[1]||''); return Math.floor((b64.length*3)/4); }
  async function compressImage(file, maxSide=1600, quality=0.7){
    if (!file) return null;
    const src = await toDataURL(file);
    const img = new Image(); img.src = src; await img.decode();
    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSide/Math.max(w,h));
    const cw = Math.round(w*scale), ch = Math.round(h*scale);
    const canvas = document.createElement('canvas'); canvas.width=cw; canvas.height=ch;
    canvas.getContext('2d').drawImage(img,0,0,cw,ch);
    return canvas.toDataURL('image/jpeg', quality);
  }

  /* 住所生成：GSI(町字・丁目) + Nominatim(番地のみ) */
  function pick(obj, keys){ for(const k of keys){ if(obj && obj[k]) return obj[k]; } return ''; }
  function joinJP(...p){ return p.filter(Boolean).join(''); }

  async function getFromGSI(lat, lon){
    // 町字（lv01/02/03）と muniNm（市区町村名）を取得
    const url = `https://mreversegeocoder.gsi.go.jp/reverse-geocoder/LonLatToAddress?lat=${lat}&lon=${lon}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('GSI HTTP '+r.status);
    const j = await r.json();
    const x = j.results || {};
    // 例：muniNm=大阪市中央区, lv01Nm=内平野町, lv02Nm=二丁目
    const muni = x.muniNm || '';
    const town = [x.lv01Nm, x.lv02Nm, x.lv03Nm].filter(Boolean).join('');
    return { muni, town };
  }

  async function getHouseNumber(lat, lon){
    // ★メールは任意で自分のに変更推奨。POI名・道路は無視、番地だけ取る。
    const email = 'you@example.com';
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=20&addressdetails=1&accept-language=ja&email=${encodeURIComponent(email)}`;
    const r = await fetch(url, { headers:{ 'User-Agent': `TokyoParcelMapper/1.0 (+${email})` }});
    if (!r.ok) throw new Error('RG HTTP '+r.status);
    const j = await r.json();
    const a = j.address || {};
    // house_number が最優先。block/lot_number があれば補助的に採用。
    const house = pick(a, ['house_number','lot_number','block']);
    return house || '';
  }

  async function getBestAddress(lat, lon){
    // 1) GSIで：市区町村＋町字＋丁目
    let muni='', town='';
    try{ const g = await getFromGSI(lat, lon); muni=g.muni; town=g.town; }catch(_){}
    // 2) Nominatimで：番地（2-4 等）
    let house='';
    try{ house = await getHouseNumber(lat, lon); }catch(_){}
    // 3) 都道府県はGSIにはないので、Nominatimの state を使う（なければ空）
    let state='';
    try{
      const email = 'you@example.com';
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=ja&email=${encodeURIComponent(email)}`;
      const r = await fetch(url, { headers:{ 'User-Agent': `TokyoParcelMapper/1.0 (+${email})` }});
      const j = await r.json(); state = (j.address||{}).state || '';
    }catch(_){}

    // 4) 日本式で結合（道路やテナント名は一切使わない）
    //    大阪府大阪市中央区 + 内平野町二丁目 + 2-4
    const line = joinJP(state, muni, town, house ? house : '');
    return line || joinJP(muni, town); // 最低でも 〇市〇区〇丁目 まで返す
  }

  /* MapLibre */
  const map = new maplibregl.Map({
    container:'map',
    style:{ version:8, sources:{ gsi:{ type:'raster', tiles:[GSI], tileSize:256, attribution:'地理院タイル' } },
            layers:[ { id:'gsi', type:'raster', source:'gsi' } ] },
    center:[139.7671,35.6812], zoom:14
  });

  /* 現在地追従 */
  let follow = true, watchId=null;
  const me = new maplibregl.Marker({ color:'#06b6d4' });
  map.on('load', ()=>{
    if (!navigator.geolocation){ toast('位置情報が使えません'); return; }
    watchId = navigator.geolocation.watchPosition(p=>{
      const {latitude:lat, longitude:lon} = p.coords;
      me.setLngLat([lon,lat]).addTo(map);
      if (follow) map.easeTo({center:[lon,lat], duration:500});
    }, ()=>toast('位置情報取得に失敗'), { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
  });
  document.getElementById('follow').onchange = (e)=> follow = e.target.checked;
  document.getElementById('goto').onclick = ()=> { follow=true; document.getElementById('follow').checked=true; };

  /* タップでピン */
  const pin = new maplibregl.Marker({ color:'#111' });
  let last = null;
  map.on('click', (e)=>{
    const {lng,lat} = e.lngLat;
    pin.setLngLat([lng,lat]).addTo(map);
    last = { lat, lon: lng };
    document.getElementById('send').disabled = false;
    toast(`選択: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
  });

  /* 送信（送信中ロック） */
  let sending = false;
  document.getElementById('send').onclick = async ()=>{
    if (!last){ toast('地図をタップして地点を選んでください'); return; }
    if (sending) return;
    sending = true; document.getElementById('send').disabled = true; showBusy(true);

    try{
      const category = document.getElementById('category').value;
      const memo = document.getElementById('memo').value.trim();
      const file = document.getElementById('photo').files[0];

      // 住所（丁目＋番地まで）。道路やテナント名は採用しない。
      let address = '';
      try { address = await getBestAddress(last.lat, last.lon); } catch(_){}

      // 写真（任意）：JPEG圧縮
      let photo = null, photoName = null;
      if (file){
        try{
          photo = await compressImage(file, 1600, 0.7);
          photoName = (file.name || 'photo.jpg').replace(/\.[^.]+$/, '.jpg');
          const kb = Math.round(dataUrlBytes(photo)/1024);
          toast(`写真を添付（約 ${kb} KB）`);
        }catch(_){}
      }

      const payload = {
        timestamp: new Date().toISOString(), // JST化はGAS側
        lat: last.lat, lon: last.lon,
        category, memo,
        address,          // ← 丁目＋番地まで
        parcel: {},       // 地番は別レイヤで対応予定
        photo, photoName
      };

      const res = await fetch(GAS_ENDPOINT, {
        method:'POST', mode:'cors',
        headers:{ 'Content-Type':'text/plain' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      toast('送信しました（シートに保存）');
      document.getElementById('memo').value='';
      document.getElementById('photo').value='';
    }catch(e){
      toast('送信に失敗。電波復帰後に再送します');
      const q = JSON.parse(localStorage.getItem('queue')||'[]');
      q.push({timestamp:new Date().toISOString(), lat:last.lat, lon:last.lon,
              category:document.getElementById('category').value,
              memo:document.getElementById('memo').value.trim(),
              address:'', parcel:{}, photo:null, photoName:null});
      localStorage.setItem('queue', JSON.stringify(q));
    }finally{
      sending = false; document.getElementById('send').disabled = false; showBusy(false);
    }
  };

  /* オフライン再送 */
  async function flush(){
    const q = JSON.parse(localStorage.getItem('queue')||'[]');
    if (!q.length) return;
    for (const item of q){
      try{
        const r = await fetch(GAS_ENDPOINT, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(item) });
        if (!r.ok) throw 0;
      }catch{ return; }
    }
    localStorage.removeItem('queue'); toast('オフライン分を再送しました');
  }
  window.addEventListener('online', flush); flush();
</script>
</body>
</html>
